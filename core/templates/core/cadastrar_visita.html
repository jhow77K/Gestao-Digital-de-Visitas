{% extends 'core/base.html' %} 
{% block content %}

<div class="cadastrar-page">
  <div class="cadastrar-card" id="form-section" aria-hidden="false">
    <h2>Agendar visita</h2>
    <p class="lead">Preencha os dados abaixo para solicitar o agendamento.</p>

    {% if messages %}
    <div class="mensagem-erro" role="alert">
      {% for message in messages %} {{ message }} {% endfor %}
    </div>
    {% endif %}

  <form method="post" id="visita-form">
      {% csrf_token %}

      {% if request.user.is_superuser or request.user.is_staff %}
      <div class="form-row">
        <div class="form-field">
          <label for="escola_id">Escola</label>
          <select name="escola_id" id="escola_id" required>
            <option value="">Selecione</option>
            {% for e in escolas %}
              <option value="{{ e.id }}" {% if selected_escola_id == e.id %}selected{% endif %}>{{ e.nome }}</option>
            {% endfor %}
          </select>
          <div class="hint">Escolha para qual escola será feita a visita.</div>
        </div>
      </div>
      {% endif %}

      <div class="form-row" id="form-row-data">
        <div class="form-field">
          <label id="data-label" for="data_sugerida">Data da visita</label>
          <input type="date" name="data_sugerida" id="data_sugerida" aria-labelledby="data-label" required value="{{ data_escolhida }}" />
          <div class="hint">Selecione a data desejada para a visita.</div>
        </div>
        <div class="form-field">
          <label id="periodo-label">Período</label>
          <div class="segmented" role="radiogroup" aria-labelledby="periodo-label">
            <input type="radio" name="periodo" id="periodo-manha" value="manha" required>
            <label for="periodo-manha">Manhã</label>
            <input type="radio" name="periodo" id="periodo-tarde" value="tarde">
            <label for="periodo-tarde">Tarde</label>
          </div>
          <div class="hint">Escolha o período (manhã ou tarde).</div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-field narrow">
          <label for="numero_previsto_criancas">Nº previsto de crianças</label>
          <input type="number" name="numero_previsto_criancas" id="numero_previsto_criancas" min="0" inputmode="numeric" placeholder="Ex.: 35" required />
        </div>
        <div class="form-field narrow">
          <label for="numero_previsto_adultos">Nº previsto de adultos</label>
          <input type="number" name="numero_previsto_adultos" id="numero_previsto_adultos" min="0" inputmode="numeric" placeholder="Ex.: 4" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="forma_pagamento">Forma de pagamento</label>
          <select name="forma_pagamento" id="forma_pagamento" required>
            <option value="">Selecione</option>
            <option value="dinheiro">Dinheiro</option>
            <option value="pix">Pix</option>
          </select>
        </div>
        <div class="form-field">
          <label for="responsavel">Responsável pela visita</label>
          <input type="text" name="responsavel" id="responsavel" placeholder="Nome completo" required />
        </div>
      </div>

      <div class="form-row">
        <div class="form-field">
          <label for="agencia">Agência</label>
          <select name="agencia" id="agencia" required>
            <option value="">Selecione</option>
            <option value="Sim">Sim</option>
            <option value="Não">Não</option>
          </select>
        </div>
        <div class="form-field full">
          <label for="observacoes">Observações</label>
          <textarea name="observacoes" id="observacoes" rows="4" placeholder="Informações adicionais (opcional)"></textarea>
        </div>
      </div>

      <div class="actions-row space-between">
        <a href="{% url 'home' %}" class="btn-secondary" aria-label="Voltar para a página inicial">Voltar</a>
        <button type="submit" class="btn-primary btn-auto">Agendar visita</button>
      </div>
      
    </form>
  </div>
</div>
<script>
  // Garantir que a data mínima seja hoje e pré-preencher com o valor vindo do servidor
  document.addEventListener("DOMContentLoaded", function () {
    const dataInput = document.getElementById("data_sugerida");
    const today = new Date().toISOString().split("T")[0];
    dataInput.setAttribute("min", today);
    if (!dataInput.value) {
      dataInput.value = today;
    }
  });
</script>
{% endblock %}
